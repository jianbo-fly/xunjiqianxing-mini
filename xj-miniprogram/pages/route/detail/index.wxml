<view class="page-route-detail">
  <!-- é¡¶éƒ¨å¯¼èˆªï¼ˆé€æ˜æ‚¬æµ®ï¼‰ -->
  <view class="nav-header" style="padding-top: {{statusBarHeight}}px;">
    <view class="nav-btn nav-btn--back" bindtap="handleBack">
      <text>â€¹</text>
    </view>
    <view class="nav-btn nav-btn--share" bindtap="onShareAppMessage">
      <image src="/assets/icons/common/share.png" mode="aspectFit" />
    </view>
  </view>

  <!-- åŠ è½½ä¸­ -->
  <view class="loading-container" wx:if="{{loading}}">
    <xj-loading text="åŠ è½½ä¸­..." vertical />
  </view>

  <!-- ä¸»å†…å®¹ -->
  <scroll-view class="main-scroll" scroll-y wx:if="{{!loading && route}}">
    <!-- å›¾ç‰‡è½®æ’­ -->
    <view class="banner-section">
      <swiper
        class="banner-swiper"
        autoplay
        circular
        bindchange="handleSwiperChange"
      >
        <swiper-item
          wx:for="{{bannerImages}}"
          wx:key="index"
          data-index="{{index}}"
          bindtap="handlePreviewImage"
        >
          <image class="banner-image" src="{{item}}" mode="aspectFill" />
        </swiper-item>
      </swiper>
      <view class="banner-indicator">{{swiperIndex + 1}}/{{bannerImages.length}}</view>
    </view>

    <!-- åŸºæœ¬ä¿¡æ¯ -->
    <view class="info-section">
      <view class="route-name">{{route.name}}</view>
      <view class="route-subtitle" wx:if="{{route.subtitle}}">{{route.subtitle}}</view>

      <view class="route-tags" wx:if="{{route.tags && route.tags.length}}">
        <view class="route-tag" wx:for="{{route.tags}}" wx:key="index">{{item}}</view>
      </view>

      <view class="route-meta">
        <view class="route-rating" wx:if="{{route.score}}">
          <text class="rating-star">â˜…</text>
          <text class="rating-value">{{route.score}}</text>
        </view>
        <text class="route-sales" wx:if="{{route.salesCount}}">å·²å”®{{route.salesCount}}äºº</text>
        <text class="route-city" wx:if="{{route.departureCity}}">{{route.departureCity}}å‡ºå‘</text>
      </view>

      <view class="route-price">
        <text class="price-symbol">Â¥</text>
        <text class="price-value">{{selectedPrice || route.minPrice}}</text>
        <text class="price-unit">/äººèµ·</text>
      </view>
    </view>

    <!-- è¡Œç¨‹äº®ç‚¹ -->
    <view class="highlight-section" wx:if="{{route.highlights && route.highlights.length}}">
      <view class="section-title">è¡Œç¨‹äº®ç‚¹</view>
      <view class="highlight-list">
        <view class="highlight-item" wx:for="{{route.highlights}}" wx:key="index">
          <text class="highlight-icon">âœ“</text>
          <text class="highlight-text">{{item}}</text>
        </view>
      </view>
    </view>

    <!-- é€‰æ‹©å¥—é¤å’Œæ—¥æœŸ -->
    <view class="select-section">
      <view class="select-item" bindtap="handleShowPackage">
        <text class="select-label">å¥—é¤</text>
        <view class="select-value">
          <text>{{selectedPackage ? selectedPackage.name : 'è¯·é€‰æ‹©å¥—é¤'}}</text>
          <text class="select-arrow">â€º</text>
        </view>
      </view>
      <view class="select-item" bindtap="handleShowCalendar">
        <text class="select-label">æ—¥æœŸ</text>
        <view class="select-value">
          <text>{{selectedDate || 'è¯·é€‰æ‹©å‡ºè¡Œæ—¥æœŸ'}}</text>
          <text class="select-arrow">â€º</text>
        </view>
      </view>
    </view>

    <!-- é€‰æ‹©äººæ•°ï¼ˆé€‰æ‹©æ—¥æœŸåæ˜¾ç¤ºï¼‰ -->
    <view class="people-section" wx:if="{{selectedDate}}">
      <view class="section-title">é€‰æ‹©äººæ•°</view>

      <!-- æˆäºº -->
      <view class="people-item">
        <view class="people-info">
          <view class="people-type">æˆäºº</view>
          <view class="people-price">Â¥{{selectedPrice}}/äºº</view>
          <view class="people-desc">12å‘¨å²åŠä»¥ä¸Š</view>
        </view>
        <view class="quantity-picker">
          <view class="quantity-btn {{adultCount <= 1 ? 'quantity-btn--disabled' : ''}}" bindtap="handleAdultMinus">-</view>
          <text class="quantity-value">{{adultCount}}</text>
          <view class="quantity-btn" bindtap="handleAdultPlus">+</view>
        </view>
      </view>

      <!-- å„¿ç«¥ -->
      <view class="people-item">
        <view class="people-info">
          <view class="people-type">å„¿ç«¥</view>
          <view class="people-price">Â¥{{selectedChildPrice}}/äºº</view>
          <view class="people-desc">2-12å‘¨å²ï¼Œä¸å åºŠ</view>
        </view>
        <view class="quantity-picker">
          <view class="quantity-btn {{childCount <= 0 ? 'quantity-btn--disabled' : ''}}" bindtap="handleChildMinus">-</view>
          <text class="quantity-value">{{childCount}}</text>
          <view class="quantity-btn {{childCount >= adultCount ? 'quantity-btn--disabled' : ''}}" bindtap="handleChildPlus">+</view>
        </view>
      </view>

      <!-- åˆè®¡é‡‘é¢ -->
      <view class="total-amount">
        <text class="total-label">ğŸ’° åˆè®¡ï¼š</text>
        <text class="total-value">Â¥{{totalAmount}}</text>
      </view>
    </view>

    <!-- å†…å®¹Tab -->
    <view class="content-section">
      <view class="content-tabs">
        <view
          class="content-tab {{contentTab === index ? 'content-tab--active' : ''}}"
          wx:for="{{contentTabs}}"
          wx:key="index"
          data-index="{{index}}"
          bindtap="handleContentTabChange"
        >
          <text>{{item}}</text>
          <view class="content-tab__line" wx:if="{{contentTab === index}}"></view>
        </view>
      </view>

      <!-- è¡Œç¨‹å®‰æ’ -->
      <view class="content-panel" wx:if="{{contentTab === 0}}">
        <view class="itinerary-list" wx:if="{{route.itinerary && route.itinerary.length}}">
          <view class="itinerary-day-card" wx:for="{{route.itinerary}}" wx:key="index">
            <!-- æ—¥æœŸæ ‡é¢˜ -->
            <view class="day-header">
              <view class="day-badge">D{{item.day || index + 1}}</view>
              <view class="day-title">{{item.title}}</view>
            </view>

            <!-- æ—¶é—´è½´æ´»åŠ¨åˆ—è¡¨ -->
            <view class="timeline" wx:if="{{item.activities && item.activities.length}}">
              <view class="timeline-item" wx:for="{{item.activities}}" wx:for-item="act" wx:key="idx">
                <view class="timeline-dot">
                  <image class="timeline-icon" src="/assets/icons/itinerary/{{act.icon || 'default'}}.png" mode="aspectFit" />
                </view>
                <view class="timeline-content">
                  <text class="timeline-time" wx:if="{{act.time}}">{{act.time}}</text>
                  <text class="timeline-text">{{act.content}}</text>
                </view>
              </view>
            </view>

            <!-- é¤é£Ÿå’Œä½å®¿ -->
            <view class="day-footer">
              <view class="day-info" wx:if="{{item.meals}}">
                <text class="info-icon">ğŸ½ï¸</text>
                <text class="info-text">{{item.meals}}</text>
              </view>
              <view class="day-info" wx:if="{{item.hotel}}">
                <text class="info-icon">ğŸ¨</text>
                <text class="info-text">{{item.hotel}}</text>
              </view>
            </view>
          </view>
        </view>
        <view class="empty-content" wx:else>
          <text>æš‚æ— è¡Œç¨‹å®‰æ’</text>
        </view>
      </view>

      <!-- è´¹ç”¨è¯´æ˜ -->
      <view class="content-panel" wx:if="{{contentTab === 1}}">
        <view class="fee-section" wx:if="{{route.costExclude}}">
          <view class="fee-title">è´¹ç”¨ä¸å«</view>
          <view class="fee-content">
            <rich-text nodes="{{route.costExclude}}"></rich-text>
          </view>
        </view>
        <view class="fee-section" wx:if="{{route.tips}}">
          <view class="fee-title">æ¸©é¦¨æç¤º</view>
          <view class="fee-content">
            <rich-text nodes="{{route.tips}}"></rich-text>
          </view>
        </view>
        <view class="empty-content" wx:if="{{!route.costExclude && !route.tips}}">
          <text>æš‚æ— è´¹ç”¨è¯´æ˜</text>
        </view>
      </view>

      <!-- é¢„è®¢é¡»çŸ¥ -->
      <view class="content-panel" wx:if="{{contentTab === 2}}">
        <view class="notice-content" wx:if="{{route.bookingNotice}}">
          <rich-text nodes="{{route.bookingNotice}}"></rich-text>
        </view>
        <view class="notice-list" wx:elif="{{route.notices && route.notices.length}}">
          <view class="notice-item" wx:for="{{route.notices}}" wx:key="index">
            <text class="notice-num">{{index + 1}}.</text>
            <text>{{item}}</text>
          </view>
        </view>
        <view class="empty-content" wx:else>
          <text>æš‚æ— é¢„è®¢é¡»çŸ¥</text>
        </view>
      </view>
    </view>

    <!-- åº•éƒ¨å ä½ -->
    <view class="bottom-placeholder"></view>
  </scroll-view>

  <!-- åº•éƒ¨æ“ä½œæ  -->
  <view class="action-bar" wx:if="{{!loading}}">
    <view class="action-bar__left">
      <view class="action-btn" bindtap="handleFavorite">
        <image class="action-btn__icon" src="/assets/icons/common/{{isFavorite ? 'favorite-active' : 'favorite'}}.png" mode="aspectFit" />
        <text class="action-btn__text">{{isFavorite ? 'å·²æ”¶è—' : 'æ”¶è—'}}</text>
      </view>
      <view class="action-btn" bindtap="handleService">
        <image class="action-btn__icon" src="/assets/icons/common/service.png" mode="aspectFit" />
        <text class="action-btn__text">å®¢æœ</text>
      </view>
    </view>
    <view class="action-bar__right">
      <view class="book-btn" bindtap="handleBook">
        <text>ç«‹å³é¢„è®¢</text>
      </view>
    </view>
  </view>

  <!-- å¥—é¤é€‰æ‹©å¼¹çª— -->
  <view class="popup-mask" wx:if="{{showPackagePopup}}" bindtap="handleClosePackage"></view>
  <view class="popup-container popup-container--package {{showPackagePopup ? 'popup-container--show' : ''}}">
    <view class="popup-header">
      <text class="popup-title">é€‰æ‹©å¥—é¤</text>
      <text class="popup-close" bindtap="handleClosePackage">Ã—</text>
    </view>
    <scroll-view class="popup-scroll" scroll-y>
      <view
        class="package-item {{selectedPackage && selectedPackage.id === item.id ? 'package-item--active' : ''}}"
        wx:for="{{packages}}"
        wx:key="id"
        data-index="{{index}}"
        bindtap="handlePackageSelect"
      >
        <view class="package-header">
          <view class="package-name">{{item.name}}</view>
          <view class="package-tags" wx:if="{{item.tags && item.tags.length}}">
            <text class="package-tag" wx:for="{{item.tags}}" wx:for-item="tag" wx:key="*this">{{tag}}</text>
          </view>
        </view>
        <view class="package-attrs" wx:if="{{item.attrsDisplay && item.attrsDisplay.length}}">
          <text class="package-attr" wx:for="{{item.attrsDisplay}}" wx:for-item="attr" wx:key="*this">{{attr}}</text>
        </view>
        <view class="package-price">Â¥{{item.basePrice}}<text class="package-price-unit">/äºº</text></view>
      </view>
      <view class="empty-content" wx:if="{{!packages.length}}">
        <text>æš‚æ— å¯é€‰å¥—é¤</text>
      </view>
    </scroll-view>
    <view class="popup-footer">
      <button class="popup-btn" bindtap="handleClosePackage">ç¡®å®š</button>
    </view>
  </view>

  <!-- æ—¥æœŸé€‰æ‹©å¼¹çª— -->
  <view class="popup-mask" wx:if="{{showCalendarPopup}}" bindtap="handleCloseCalendar"></view>
  <view class="popup-container popup-container--calendar {{showCalendarPopup ? 'popup-container--show' : ''}}">
    <view class="popup-header">
      <text class="popup-title">é€‰æ‹©å‡ºè¡Œæ—¥æœŸ</text>
      <text class="popup-close" bindtap="handleCloseCalendar">Ã—</text>
    </view>
    <view class="calendar-month-switcher">
      <view class="month-btn {{!canGoPrevMonth ? 'month-btn--disabled' : ''}}" bindtap="handlePrevMonth">
        <text>â€¹</text>
      </view>
      <text class="calendar-month-text">{{currentMonth}}</text>
      <view class="month-btn" bindtap="handleNextMonth">
        <text>â€º</text>
      </view>
    </view>
    <scroll-view class="popup-scroll calendar-scroll" scroll-y>
      <view class="calendar-grid">
        <view
          class="calendar-item {{item.stock <= 0 ? 'calendar-item--disabled' : ''}} {{selectedDate === item.date ? 'calendar-item--active' : ''}} {{item.isWeekend ? 'calendar-item--weekend' : ''}}"
          wx:for="{{calendar}}"
          wx:key="date"
          data-item="{{item}}"
          bindtap="handleDateSelect"
        >
          <text class="calendar-date">{{item.day}}æ—¥</text>
          <text class="calendar-price" wx:if="{{item.stock > 0}}">Â¥{{item.price}}</text>
          <text class="calendar-sold" wx:else>å”®ç½„</text>
        </view>
      </view>
    </scroll-view>
  </view>
</view>
