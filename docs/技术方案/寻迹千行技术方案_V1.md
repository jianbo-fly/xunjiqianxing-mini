# 寻迹千行 技术方案文档

**版本：V1.0 | 日期：2026年1月**

---

# 第一部分：项目概述

## 1.1 项目背景

寻迹千行是一个综合旅游服务平台，一期聚焦「旅行」业务，后续扩展租车、民宿、门票、美食等模块。

## 1.2 产品形态

| 端 | 形态 | 用户 |
|---|---|---|
| C端 | 微信小程序 | 普通用户、会员、领队、推广员 |
| B端 | PC Web管理后台 | 供应商、管理员 |

## 1.3 技术目标

| 目标 | 说明 |
|------|------|
| 可扩展 | 支持快速接入新业务线（租车、酒店、门票等） |
| 可演进 | 单体起步，可平滑升级为微服务架构 |
| 高可用 | 核心业务99.9%可用性 |
| 安全性 | 数据加密、防注入、权限控制 |

## 1.4 业务模块划分

### 一期（P0）

| 模块 | 功能范围 |
|------|---------|
| 用户 | 登录注册、用户信息、出行人管理 |
| 商品 | 跟团游线路、套餐、价格库存 |
| 订单 | 下单、支付、状态流转、退款 |
| 会员 | 会员开通、权益 |
| 领队 | 申请、审核、带队 |
| 推广 | 推广员、推广码、积分 |
| 定制 | 定制需求、跟进管理 |
| 消息 | 站内消息、微信订阅消息 |
| 内容 | 轮播图、分类管理 |
| 系统 | 供应商、管理员、系统配置 |

### 二期及后续

| 模块 | 说明 |
|------|------|
| 租车自驾 | 车型、取还车、租车订单 |
| 民宿酒店 | 房型、日历房价、预订 |
| 景点门票 | 票种、日期票价、预订 |
| 接送包车 | 用车服务 |
| 美食玩乐 | 餐饮、娱乐预订 |
| 租赁服务 | 旅游装备租赁 |
| 旅游保险 | 保险产品 |

---

# 第二部分：技术架构

## 2.1 架构设计原则

| 原则 | 说明 |
|------|------|
| 模块化 | 按业务领域划分模块，边界清晰 |
| 接口隔离 | 模块间通过接口通信，降低耦合 |
| 数据隔离 | 表名加模块前缀，禁止跨模块JOIN |
| 事件驱动 | 关键业务通过事件解耦 |
| 配置外置 | 配置与代码分离 |
| 无状态 | 服务无状态，Session外置 |

## 2.2 整体架构图

```
┌────────────────────────────────────────────────────────────────────┐
│                            客户端                                   │
├─────────────────────────────┬──────────────────────────────────────┤
│      微信小程序 (C端)        │          Web管理后台 (B端)            │
│      原生 / uni-app         │        Vue3 + Element Plus           │
└─────────────┬───────────────┴──────────────────┬───────────────────┘
              │               HTTPS              │
              ▼                                  ▼
┌────────────────────────────────────────────────────────────────────┐
│                         Nginx 网关                                  │
│                  (SSL终止、负载均衡、静态资源)                        │
└────────────────────────────────┬───────────────────────────────────┘
                                 │
┌────────────────────────────────▼───────────────────────────────────┐
│                         聚合层 (BFF)                                │
│             xj-app (小程序API)    xj-admin (管理后台API)             │
└────────────────────────────────┬───────────────────────────────────┘
                                 │
┌────────────────────────────────▼───────────────────────────────────┐
│                          服务层                                     │
│  ┌──────┐ ┌───────┐ ┌──────┐ ┌───────┐ ┌───────┐ ┌──────┐        │
│  │ User │ │Product│ │Order │ │Payment│ │Message│ │Member│ ...    │
│  └──────┘ └───────┘ └──────┘ └───────┘ └───────┘ └──────┘        │
│                                                                    │
│                       Spring Event 事件总线                         │
└────────────────────────────────┬───────────────────────────────────┘
                                 │
┌────────────────────────────────▼───────────────────────────────────┐
│                          数据层                                     │
│    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐          │
│    │    MySQL    │    │    Redis    │    │  腾讯云COS   │          │
│    │   8.0       │    │    7.x      │    │   文件存储   │          │
│    └─────────────┘    └─────────────┘    └─────────────┘          │
└────────────────────────────────────────────────────────────────────┘
```

## 2.3 微服务演进架构

```
┌────────────────────────────────────────────────────────────────────┐
│                       Spring Cloud Gateway                          │
└────────────────────────────────┬───────────────────────────────────┘
                                 │
        ┌────────────────────────┼────────────────────────┐
        ▼                        ▼                        ▼
   ┌─────────┐             ┌─────────┐             ┌─────────┐
   │  User   │             │ Product │             │  Order  │
   │ Service │             │ Service │             │ Service │
   └────┬────┘             └────┬────┘             └────┬────┘
        │                       │                       │
   ┌────▼────┐             ┌────▼────┐             ┌────▼────┐
   │  MySQL  │             │  MySQL  │             │  MySQL  │
   └─────────┘             └─────────┘             └─────────┘
                                 │
                    ┌────────────▼────────────┐
                    │    RocketMQ / Kafka     │
                    └─────────────────────────┘
                                 │
                    ┌────────────▼────────────┐
                    │         Nacos           │
                    │   (注册中心 + 配置中心)   │
                    └─────────────────────────┘
```

## 2.4 项目模块结构

```
xunjiqianxing/
├── pom.xml                        # 父POM
│
├── xj-common/                     # 公共模块
│   ├── src/main/java/
│   │   └── com/xunjiqianxing/common/
│   │       ├── constant/          # 常量定义
│   │       ├── enums/             # 枚举类
│   │       │   ├── BizType.java   # 业务类型枚举
│   │       │   ├── OrderStatus.java
│   │       │   └── ...
│   │       ├── exception/         # 异常定义
│   │       │   ├── BizException.java
│   │       │   └── ErrorCode.java
│   │       ├── result/            # 统一响应
│   │       │   └── Result.java
│   │       ├── utils/             # 工具类
│   │       │   ├── IdGenerator.java   # 雪花ID
│   │       │   ├── DateUtils.java
│   │       │   └── ...
│   │       └── event/             # 事件基类
│   │           └── BaseEvent.java
│   └── pom.xml
│
├── xj-api/                        # 接口定义模块
│   ├── xj-api-user/
│   │   └── src/main/java/
│   │       └── com/xunjiqianxing/api/user/
│   │           ├── UserApi.java
│   │           └── dto/
│   │               └── UserDTO.java
│   ├── xj-api-product/
│   ├── xj-api-order/
│   ├── xj-api-payment/
│   ├── xj-api-message/
│   └── pom.xml
│
├── xj-service/                    # 服务实现模块
│   ├── xj-service-user/           # 用户服务
│   │   └── src/main/java/
│   │       └── com/xunjiqianxing/service/user/
│   │           ├── controller/
│   │           ├── service/
│   │           │   ├── UserService.java
│   │           │   └── impl/
│   │           ├── mapper/
│   │           ├── entity/
│   │           ├── converter/     # DTO转换
│   │           └── event/         # 领域事件
│   ├── xj-service-product/        # 商品服务
│   ├── xj-service-order/          # 订单服务
│   ├── xj-service-payment/        # 支付服务
│   ├── xj-service-message/        # 消息服务
│   ├── xj-service-member/         # 会员服务
│   ├── xj-service-promotion/      # 推广服务
│   ├── xj-service-content/        # 内容服务
│   ├── xj-service-custom/         # 定制服务
│   └── pom.xml
│
├── xj-biz/                        # 业务扩展模块
│   ├── xj-biz-route/              # 跟团游业务
│   │   └── src/main/java/
│   │       └── com/xunjiqianxing/biz/route/
│   │           ├── handler/
│   │           │   ├── RouteProductHandler.java
│   │           │   └── RouteOrderHandler.java
│   │           ├── service/
│   │           └── entity/
│   ├── xj-biz-car/                # 租车业务（预留）
│   ├── xj-biz-hotel/              # 酒店业务（预留）
│   ├── xj-biz-ticket/             # 门票业务（预留）
│   └── pom.xml
│
├── xj-app/                        # 小程序聚合服务
│   └── src/main/java/
│       └── com/xunjiqianxing/app/
│           ├── XjAppApplication.java
│           ├── controller/        # C端API
│           │   ├── HomeController.java
│           │   ├── RouteController.java
│           │   ├── OrderController.java
│           │   └── ...
│           └── config/
│
├── xj-admin/                      # 管理后台聚合服务
│   └── src/main/java/
│       └── com/xunjiqianxing/admin/
│           ├── XjAdminApplication.java
│           ├── controller/        # B端API
│           │   ├── RouteAdminController.java
│           │   ├── OrderAdminController.java
│           │   └── ...
│           └── config/
│
└── docs/                          # 文档
    ├── api/                       # API文档
    └── sql/                       # SQL脚本
```

---

# 第三部分：技术选型

## 3.1 前端技术栈

### 小程序端

| 技术 | 版本 | 说明 |
|------|------|------|
| 微信小程序 | - | 原生开发 或 uni-app |
| uni-app | 3.x | 可选，跨端框架 |
| uni-ui | - | UI组件库 |
| Pinia | 2.x | 状态管理 |
| dayjs | 1.x | 日期处理 |

### 管理后台

| 技术 | 版本 | 说明 |
|------|------|------|
| Vue | 3.4+ | 前端框架 |
| Element Plus | 2.x | UI组件库 |
| Vite | 5.x | 构建工具 |
| Vue Router | 4.x | 路由 |
| Pinia | 2.x | 状态管理 |
| Axios | 1.x | HTTP客户端 |
| ECharts | 5.x | 图表 |
| wangEditor | 5.x | 富文本编辑器 |

## 3.2 后端技术栈

### 核心框架

| 技术 | 版本 | 说明 |
|------|------|------|
| Java | 17 LTS | 开发语言 |
| Spring Boot | 3.2.x | 应用框架 |
| Spring MVC | - | Web框架 |
| MyBatis Plus | 3.5.x | ORM框架 |
| Sa-Token | 1.37.x | 权限认证 |
| Hutool | 5.8.x | 工具库 |
| MapStruct | 1.5.x | Bean转换 |
| Lombok | 1.18.x | 代码简化 |
| Validation | - | 参数校验 |

### 数据存储

| 技术 | 版本 | 说明 |
|------|------|------|
| MySQL | 8.0 | 主数据库 |
| Redis | 7.x | 缓存、分布式锁、Session |
| 腾讯云COS | - | 对象存储 |

### 中间件

| 技术 | 版本 | 说明 |
|------|------|------|
| Nginx | 1.24+ | 反向代理、负载均衡 |
| Druid | 1.2.x | 数据库连接池 |
| Redisson | 3.x | Redis客户端、分布式锁 |

### 第三方服务

| 服务 | 用途 |
|------|------|
| 微信小程序API | 登录、手机号获取 |
| 微信支付v3 | 支付、退款 |
| 微信订阅消息 | 消息推送 |
| 企业微信API | 客服、内部通知 |
| 腾讯云COS | 图片存储 |
| 腾讯云短信 | 短信通知（可选） |

### 开发工具

| 工具 | 用途 |
|------|------|
| Maven | 构建管理 |
| Git | 版本控制 |
| Docker | 容器化 |
| Docker Compose | 本地编排 |
| Swagger/Knife4j | API文档 |

## 3.3 微服务扩展技术栈（预留）

| 技术 | 版本 | 说明 |
|------|------|------|
| Spring Cloud | 2023.x | 微服务框架 |
| Spring Cloud Alibaba | 2023.x | 阿里云组件 |
| Nacos | 2.x | 注册中心、配置中心 |
| OpenFeign | - | 服务调用 |
| Spring Cloud Gateway | - | API网关 |
| RocketMQ | 5.x | 消息队列 |
| Seata | 2.x | 分布式事务 |
| SkyWalking | 9.x | 链路追踪 |

---

# 第四部分：数据库设计

## 4.1 设计规范

### 命名规范

| 类型 | 规范 | 示例 |
|------|------|------|
| 表名 | 模块前缀_业务名，小写下划线 | `user_info`, `order_main` |
| 字段名 | 小写下划线 | `user_id`, `created_at` |
| 主键 | id，BIGINT | `id BIGINT PRIMARY KEY` |
| 外键 | 关联表_id | `user_id`, `product_id` |
| 时间字段 | xxx_at 或 xxx_time | `created_at`, `pay_time` |
| 状态字段 | status 或 is_xxx | `status`, `is_deleted` |
| 索引名 | idx_表名_字段 | `idx_order_user_id` |
| 唯一索引 | uk_表名_字段 | `uk_user_phone` |

### 字段规范

| 规范 | 说明 |
|------|------|
| 主键 | 使用雪花算法生成的BIGINT |
| 金额 | DECIMAL(10,2)，单位：元 |
| 时间 | DATETIME，存储到秒 |
| 状态 | TINYINT 或 VARCHAR(20) |
| JSON | 使用MySQL JSON类型 |
| 软删除 | is_deleted TINYINT DEFAULT 0 |
| 审计字段 | created_at, updated_at |

### 索引规范

| 规范 | 说明 |
|------|------|
| 主键索引 | 必须有主键 |
| 外键字段 | 必须建索引 |
| 查询条件 | 高频查询字段建索引 |
| 联合索引 | 遵循最左前缀原则 |
| 禁止 | 禁止建物理外键约束 |

## 4.2 用户域

### user_info 用户表

```sql
CREATE TABLE user_info (
    id BIGINT PRIMARY KEY COMMENT '用户ID',
    openid VARCHAR(64) NOT NULL COMMENT '微信openid',
    unionid VARCHAR(64) COMMENT '微信unionid',
    nickname VARCHAR(64) COMMENT '昵称',
    avatar VARCHAR(500) COMMENT '头像URL',
    phone VARCHAR(20) COMMENT '手机号',
    gender TINYINT DEFAULT 0 COMMENT '性别: 0未知 1男 2女',

    -- 身份标识
    is_member TINYINT DEFAULT 0 COMMENT '是否会员: 0否 1是',
    member_expire_at DATETIME COMMENT '会员到期时间',
    is_leader TINYINT DEFAULT 0 COMMENT '是否领队: 0否 1是',
    is_promoter TINYINT DEFAULT 0 COMMENT '是否推广员: 0否 1是',

    -- 资产
    points INT DEFAULT 0 COMMENT '积分余额',

    -- 推广绑定
    bindpromoter_id BIGINT COMMENT '绑定的推广员ID',
    bindpromoter_at DATETIME COMMENT '绑定时间',

    -- 状态
    status TINYINT DEFAULT 1 COMMENT '状态: 0禁用 1正常',
    last_login_at DATETIME COMMENT '最后登录时间',

    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    UNIQUE KEY uk_openid (openid),
    UNIQUE KEY uk_phone (phone),
    INDEX idx_bindpromoter (bindpromoter_id)
) COMMENT '用户表';
```

### user_traveler 出行人表

```sql
CREATE TABLE user_traveler (
    id BIGINT PRIMARY KEY COMMENT '出行人ID',
    user_id BIGINT NOT NULL COMMENT '所属用户ID',
    name VARCHAR(50) NOT NULL COMMENT '真实姓名',
    id_card VARCHAR(18) NOT NULL COMMENT '身份证号(加密存储)',
    id_card_hash VARCHAR(64) NOT NULL COMMENT '身份证号哈希(用于查询)',
    phone VARCHAR(20) NOT NULL COMMENT '手机号',
    traveler_type TINYINT DEFAULT 1 COMMENT '类型: 1成人 2儿童',
    is_default TINYINT DEFAULT 0 COMMENT '是否默认',

    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    INDEX idx_user (user_id)
) COMMENT '出行人表';
```

## 4.3 商品域

### product_main 商品主表

```sql
CREATE TABLE product_main (
    id BIGINT PRIMARY KEY COMMENT '商品ID',
    biz_type VARCHAR(32) NOT NULL COMMENT '业务类型: route/car/hotel/ticket/transfer/food/rental/insurance',
    supplier_id BIGINT NOT NULL COMMENT '供应商ID',

    -- 基础信息
    name VARCHAR(200) NOT NULL COMMENT '商品名称',
    subtitle VARCHAR(500) COMMENT '副标题',
    cover_image VARCHAR(500) NOT NULL COMMENT '封面图',
    images JSON COMMENT '轮播图 ["url1","url2"]',
    tags JSON COMMENT '标签 ["纯玩","品质"]',

    -- 位置信息
    city_code VARCHAR(20) COMMENT '城市编码',
    city_name VARCHAR(50) COMMENT '城市名称',

    -- 价格展示
    min_price DECIMAL(10,2) COMMENT '最低价(列表展示用)',
    original_price DECIMAL(10,2) COMMENT '原价(划线价)',

    -- 统计
    sales_count INT DEFAULT 0 COMMENT '销量',
    view_count INT DEFAULT 0 COMMENT '浏览量',
    score DECIMAL(2,1) DEFAULT 5.0 COMMENT '评分',

    -- 状态
    status TINYINT DEFAULT 0 COMMENT '状态: 0下架 1上架',
    audit_status TINYINT DEFAULT 0 COMMENT '审核状态: 0待审核 1通过 2驳回',
    audit_remark VARCHAR(500) COMMENT '审核备注',

    sort_order INT DEFAULT 0 COMMENT '排序(越大越前)',
    is_recommend TINYINT DEFAULT 0 COMMENT '是否推荐',
    is_deleted TINYINT DEFAULT 0 COMMENT '是否删除',

    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    INDEX idx_biz_type (biz_type),
    INDEX idx_supplier (supplier_id),
    INDEX idx_status (status, is_deleted),
    INDEX idx_city (city_code),
    INDEX idx_recommend (is_recommend, sort_order DESC)
) COMMENT '商品主表';
```

### product_route 跟团游扩展表

```sql
CREATE TABLE product_route (
    product_id BIGINT PRIMARY KEY COMMENT '商品ID',

    -- 线路信息
    category VARCHAR(20) NOT NULL COMMENT '分类: domestic国内游 overseas出境游',
    departure_city VARCHAR(50) NOT NULL COMMENT '出发城市',
    destination VARCHAR(100) NOT NULL COMMENT '目的地',

    -- 说明信息(线路级别)
    cost_exclude TEXT COMMENT '费用不含(富文本)',
    booking_notice TEXT COMMENT '预订须知(富文本)',
    tips TEXT COMMENT '温馨提示(富文本)',

    INDEX idx_category (category),
    INDEX idx_departure (departure_city)
) COMMENT '跟团游扩展表';
```

### product_sku SKU表(套餐/规格)

```sql
CREATE TABLE product_sku (
    id BIGINT PRIMARY KEY COMMENT 'SKU ID',
    product_id BIGINT NOT NULL COMMENT '商品ID',
    biz_type VARCHAR(32) NOT NULL COMMENT '业务类型',

    -- 基础信息
    name VARCHAR(200) NOT NULL COMMENT 'SKU名称',
    tags JSON COMMENT '标签 ["热销","纯玩"]',

    -- 业务属性(JSON灵活存储)
    attrs JSON NOT NULL COMMENT '业务属性',

    -- 价格
    base_price DECIMAL(10,2) COMMENT '基准价',
    child_price DECIMAL(10,2) COMMENT '儿童基准价(跟团游)',

    -- 状态
    status TINYINT DEFAULT 1 COMMENT '状态: 0禁用 1启用',
    sort_order INT DEFAULT 0 COMMENT '排序',

    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    INDEX idx_product (product_id),
    INDEX idx_status (status)
) COMMENT 'SKU表';

-- 跟团游套餐 attrs 示例:
-- {
--     "days": 6,                          // 行程天数
--     "hotel_level": "四星",               // 住宿等级
--     "hotel_desc": "当地四星酒店",         // 住宿说明
--     "traffic_level": "优选时段",          // 交通等级
--     "traffic_desc": "优选航班时段",       // 交通说明
--     "vehicle_level": "商务车",           // 用车等级
--     "vehicle_desc": "7座商务车",         // 用车说明
--     "meals": "5早3正",                   // 含餐数量
--     "meals_desc": "酒店含早,特色餐",      // 餐饮说明
--     "tickets_desc": "含景点首道门票",     // 门票说明
--     "self_expense": "自费项目说明",       // 自费项目
--     "shopping_count": 0,                 // 购物店数量
--     "shopping_desc": "",                 // 购物说明
--     "max_people": 16,                    // 最大人数
--     "group_label": "16人品质团",          // 团型标签
--     "itinerary": "<富文本>",             // 行程介绍
--     "cost_include": "<富文本>"           // 费用包含
-- }
```

### product_price_stock 价格库存表

```sql
CREATE TABLE product_price_stock (
    id BIGINT PRIMARY KEY,
    sku_id BIGINT NOT NULL COMMENT 'SKU ID',
    date DATE NOT NULL COMMENT '日期',

    -- 价格
    price DECIMAL(10,2) NOT NULL COMMENT '成人价格',
    child_price DECIMAL(10,2) COMMENT '儿童价格',

    -- 库存
    stock INT NOT NULL DEFAULT 0 COMMENT '总库存',
    sold INT DEFAULT 0 COMMENT '已售数量',
    locked INT DEFAULT 0 COMMENT '锁定数量(待支付)',

    -- 状态
    status TINYINT DEFAULT 1 COMMENT '状态: 0不可售 1可售',

    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    UNIQUE KEY uk_sku_date (sku_id, date),
    INDEX idx_date (date)
) COMMENT '价格库存表';
```

## 4.4 订单域

### order_main 订单主表

```sql
CREATE TABLE order_main (
    id BIGINT PRIMARY KEY COMMENT '订单ID',
    order_no VARCHAR(32) NOT NULL COMMENT '订单编号',
    biz_type VARCHAR(32) NOT NULL COMMENT '业务类型',

    -- 关联
    user_id BIGINT NOT NULL COMMENT '用户ID',
    supplier_id BIGINT NOT NULL COMMENT '供应商ID',
    product_id BIGINT NOT NULL COMMENT '商品ID',
    sku_id BIGINT NOT NULL COMMENT 'SKU ID',

    -- 冗余信息(下单时快照)
    product_name VARCHAR(200) NOT NULL COMMENT '商品名称',
    product_image VARCHAR(500) COMMENT '商品图片',
    sku_name VARCHAR(200) NOT NULL COMMENT 'SKU名称',

    -- 预订信息
    start_date DATE NOT NULL COMMENT '开始日期(出发/入住/用车)',
    end_date DATE COMMENT '结束日期',
    days INT COMMENT '天数',
    adult_count INT DEFAULT 0 COMMENT '成人数',
    child_count INT DEFAULT 0 COMMENT '儿童数',
    quantity INT DEFAULT 1 COMMENT '数量(间夜/份数)',

    -- 金额
    adult_price DECIMAL(10,2) COMMENT '成人单价',
    child_price DECIMAL(10,2) COMMENT '儿童单价',
    total_amount DECIMAL(10,2) NOT NULL COMMENT '订单总额',
    discount_amount DECIMAL(10,2) DEFAULT 0 COMMENT '优惠金额',
    pay_amount DECIMAL(10,2) NOT NULL COMMENT '实付金额',
    refund_amount DECIMAL(10,2) DEFAULT 0 COMMENT '已退金额',

    -- 优惠信息
    coupon_id BIGINT COMMENT '优惠券ID',
    coupon_amount DECIMAL(10,2) DEFAULT 0 COMMENT '优惠券金额',

    -- 联系人
    contact_name VARCHAR(50) NOT NULL COMMENT '联系人姓名',
    contact_phone VARCHAR(20) NOT NULL COMMENT '联系人电话',

    -- 订单状态
    status VARCHAR(20) NOT NULL DEFAULT 'pending_pay' COMMENT '订单状态',
    -- pending_pay: 待支付
    -- pending_confirm: 待确认
    -- confirmed: 已确认
    -- completed: 已完成
    -- cancelled: 已取消
    -- refunding: 退款中
    -- refunded: 已退款
    -- rejected: 已拒绝

    -- 支付信息
    pay_status TINYINT DEFAULT 0 COMMENT '支付状态: 0未支付 1已支付',
    pay_time DATETIME COMMENT '支付时间',
    pay_trade_no VARCHAR(64) COMMENT '支付流水号',

    -- 确认信息
    confirm_time DATETIME COMMENT '确认时间',
    reject_reason VARCHAR(500) COMMENT '拒绝原因',

    -- 取消信息
    cancel_time DATETIME COMMENT '取消时间',
    cancel_reason VARCHAR(500) COMMENT '取消原因',
    cancel_type TINYINT COMMENT '取消类型: 1用户取消 2超时取消 3商家拒绝',

    -- 完成信息
    complete_time DATETIME COMMENT '完成时间',

    -- 扩展数据
    ext_data JSON COMMENT '扩展数据(业务特有)',

    -- 推广信息
    promoter_id BIGINT COMMENT '推广员ID',

    remark VARCHAR(500) COMMENT '用户备注',
    admin_remark VARCHAR(500) COMMENT '管理员备注',

    -- 超时时间
    expire_at DATETIME COMMENT '支付超时时间',

    is_deleted TINYINT DEFAULT 0,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    UNIQUE KEY uk_order_no (order_no),
    INDEX idx_user (user_id),
    INDEX idx_supplier (supplier_id),
    INDEX idx_status (status),
    INDEX idx_start_date (start_date),
    INDEX idx_created (created_at),
    INDEX idx_promoter (promoter_id)
) COMMENT '订单主表';
```

### order_traveler 订单出行人表

```sql
CREATE TABLE order_traveler (
    id BIGINT PRIMARY KEY,
    order_id BIGINT NOT NULL COMMENT '订单ID',

    name VARCHAR(50) NOT NULL COMMENT '姓名',
    id_card VARCHAR(18) NOT NULL COMMENT '身份证号(加密)',
    phone VARCHAR(20) NOT NULL COMMENT '手机号',
    traveler_type TINYINT NOT NULL COMMENT '类型: 1成人 2儿童',

    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,

    INDEX idx_order (order_id)
) COMMENT '订单出行人表';
```

### order_refund 退款表

```sql
CREATE TABLE order_refund (
    id BIGINT PRIMARY KEY,
    refund_no VARCHAR(32) NOT NULL COMMENT '退款编号',
    order_id BIGINT NOT NULL COMMENT '订单ID',
    order_no VARCHAR(32) NOT NULL COMMENT '订单编号',
    user_id BIGINT NOT NULL COMMENT '用户ID',

    -- 退款金额
    refund_amount DECIMAL(10,2) NOT NULL COMMENT '申请退款金额',
    actual_amount DECIMAL(10,2) COMMENT '实际退款金额',
    refund_ratio INT COMMENT '退款比例(%)',

    -- 退款原因
    reason VARCHAR(500) COMMENT '退款原因',

    -- 状态
    status TINYINT DEFAULT 0 COMMENT '状态: 0待审核 1已通过 2已驳回',

    -- 审核信息
    audit_time DATETIME COMMENT '审核时间',
    audit_by BIGINT COMMENT '审核人',
    audit_remark VARCHAR(500) COMMENT '审核备注',

    -- 退款信息
    refund_time DATETIME COMMENT '退款到账时间',
    refund_trade_no VARCHAR(64) COMMENT '退款流水号',

    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    UNIQUE KEY uk_refund_no (refund_no),
    INDEX idx_order (order_id),
    INDEX idx_user (user_id),
    INDEX idx_status (status)
) COMMENT '退款表';
```

### order_log 订单日志表

```sql
CREATE TABLE order_log (
    id BIGINT PRIMARY KEY,
    order_id BIGINT NOT NULL COMMENT '订单ID',

    action VARCHAR(50) NOT NULL COMMENT '操作类型',
    from_status VARCHAR(20) COMMENT '原状态',
    to_status VARCHAR(20) COMMENT '新状态',

    content VARCHAR(500) COMMENT '操作内容',
    operator_type TINYINT COMMENT '操作人类型: 1用户 2供应商 3管理员 4系统',
    operator_id BIGINT COMMENT '操作人ID',
    operator_name VARCHAR(50) COMMENT '操作人名称',

    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,

    INDEX idx_order (order_id)
) COMMENT '订单日志表';
```

## 4.5 支付域

### payment_record 支付记录表

```sql
CREATE TABLE payment_record (
    id BIGINT PRIMARY KEY,
    payment_no VARCHAR(32) NOT NULL COMMENT '支付流水号',

    -- 业务信息
    biz_type VARCHAR(32) NOT NULL COMMENT '业务类型: order/member/leader',
    biz_id BIGINT NOT NULL COMMENT '业务ID',
    biz_no VARCHAR(32) NOT NULL COMMENT '业务编号',

    user_id BIGINT NOT NULL COMMENT '用户ID',

    -- 金额
    amount DECIMAL(10,2) NOT NULL COMMENT '支付金额',

    -- 支付信息
    pay_channel VARCHAR(20) NOT NULL DEFAULT 'wechat' COMMENT '支付渠道',
    pay_type VARCHAR(20) COMMENT '支付方式: jsapi/native/app',

    -- 状态
    status TINYINT DEFAULT 0 COMMENT '状态: 0待支付 1已支付 2已关闭',

    -- 微信支付信息
    prepay_id VARCHAR(64) COMMENT '预支付ID',
    transaction_id VARCHAR(64) COMMENT '微信支付订单号',
    pay_time DATETIME COMMENT '支付成功时间',

    -- 回调信息
    notify_data TEXT COMMENT '回调原始数据',

    expire_at DATETIME COMMENT '超时时间',

    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    UNIQUE KEY uk_payment_no (payment_no),
    INDEX idx_biz (biz_type, biz_id),
    INDEX idx_user (user_id),
    INDEX idx_status (status)
) COMMENT '支付记录表';
```

## 4.6 会员域

### member_order 会员订单表

```sql
CREATE TABLE member_order (
    id BIGINT PRIMARY KEY,
    order_no VARCHAR(32) NOT NULL COMMENT '订单编号',
    user_id BIGINT NOT NULL COMMENT '用户ID',

    -- 金额
    amount DECIMAL(10,2) NOT NULL COMMENT '支付金额',

    -- 会员时间
    start_date DATE NOT NULL COMMENT '会员开始日期',
    end_date DATE NOT NULL COMMENT '会员结束日期',
    duration_months INT NOT NULL COMMENT '购买月数',

    -- 状态
    status TINYINT DEFAULT 0 COMMENT '状态: 0待支付 1已支付 2已取消',
    pay_time DATETIME COMMENT '支付时间',

    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    UNIQUE KEY uk_order_no (order_no),
    INDEX idx_user (user_id)
) COMMENT '会员订单表';
```

## 4.7 领队域

### leader_info 领队信息表

```sql
CREATE TABLE leader_info (
    id BIGINT PRIMARY KEY COMMENT '领队ID',
    user_id BIGINT NOT NULL COMMENT '用户ID',

    -- 基本信息
    real_name VARCHAR(50) NOT NULL COMMENT '真实姓名',
    phone VARCHAR(20) NOT NULL COMMENT '手机号',
    avatar VARCHAR(500) COMMENT '头像',
    expertise JSON COMMENT '擅长领域 ["云南","西藏"]',
    intro TEXT COMMENT '个人简介',
    certificate_images JSON COMMENT '资质证书图片',

    -- 统计
    trip_count INT DEFAULT 0 COMMENT '带队次数',
    total_commission DECIMAL(10,2) DEFAULT 0 COMMENT '累计佣金',

    -- 状态
    status TINYINT DEFAULT 1 COMMENT '状态: 0禁用 1正常',

    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    UNIQUE KEY uk_user (user_id)
) COMMENT '领队信息表';
```

### leader_apply 领队申请表

```sql
CREATE TABLE leader_apply (
    id BIGINT PRIMARY KEY,
    user_id BIGINT NOT NULL COMMENT '用户ID',

    -- 申请信息
    real_name VARCHAR(50) NOT NULL COMMENT '真实姓名',
    phone VARCHAR(20) NOT NULL COMMENT '手机号',
    expertise JSON COMMENT '擅长领域',
    intro TEXT COMMENT '个人简介',
    certificate_images JSON COMMENT '资质证书图片',

    -- 状态
    status TINYINT DEFAULT 0 COMMENT '状态: 0待审核 1已通过 2已驳回',

    -- 审核信息
    audit_time DATETIME COMMENT '审核时间',
    audit_by BIGINT COMMENT '审核人',
    audit_remark VARCHAR(500) COMMENT '审核备注',

    -- 支付信息
    pay_status TINYINT DEFAULT 0 COMMENT '支付状态: 0未支付 1已支付',
    pay_amount DECIMAL(10,2) COMMENT '支付金额',
    pay_time DATETIME COMMENT '支付时间',

    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    INDEX idx_user (user_id),
    INDEX idx_status (status)
) COMMENT '领队申请表';
```

## 4.8 推广域

### promotion_user 推广员表

```sql
CREATE TABLE promotion_user (
    id BIGINT PRIMARY KEY COMMENT '推广员ID',
    user_id BIGINT NOT NULL COMMENT '用户ID',

    -- 店铺信息
    shop_name VARCHAR(100) COMMENT '店铺名称',
    shop_avatar VARCHAR(500) COMMENT '店铺头像',
    shop_address VARCHAR(500) COMMENT '店铺地址',

    -- 推广码
    promo_code VARCHAR(32) NOT NULL COMMENT '推广码',
    qrcode_url VARCHAR(500) COMMENT '小程序码URL',

    -- 统计
    scan_count INT DEFAULT 0 COMMENT '扫码人数',
    binduser_count INT DEFAULT 0 COMMENT '绑定用户数',
    order_count INT DEFAULT 0 COMMENT '成交订单数',
    total_points INT DEFAULT 0 COMMENT '累计获得积分',

    -- 状态
    status TINYINT DEFAULT 0 COMMENT '状态: 0待审核 1正常 2禁用',

    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    UNIQUE KEY uk_user (user_id),
    UNIQUE KEY uk_code (promo_code)
) COMMENT '推广员表';
```

### promotion_bindlog 推广绑定记录表

```sql
CREATE TABLE promotion_bindlog (
    id BIGINT PRIMARY KEY,
    promoter_id BIGINT NOT NULL COMMENT '推广员ID',
    user_id BIGINT NOT NULL COMMENT '被绑定用户ID',

    source VARCHAR(50) COMMENT '来源: scan扫码',

    -- 解绑信息
    unbind_time DATETIME COMMENT '解绑时间',
    unbind_reason VARCHAR(100) COMMENT '解绑原因',

    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,

    INDEX idx_promoter (promoter_id),
    INDEX idx_user (user_id)
) COMMENT '推广绑定记录表';
```

### promotion_points 积分记录表

```sql
CREATE TABLE promotion_points (
    id BIGINT PRIMARY KEY,
    user_id BIGINT NOT NULL COMMENT '用户ID',

    -- 积分变动
    points INT NOT NULL COMMENT '积分数(正为获得,负为消耗)',
    balance INT NOT NULL COMMENT '变动后余额',

    -- 来源
    source_type VARCHAR(32) NOT NULL COMMENT '来源类型: order_reward/promote_reward/consume',
    source_id BIGINT COMMENT '来源ID',
    source_no VARCHAR(32) COMMENT '来源编号',

    remark VARCHAR(200) COMMENT '备注',

    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,

    INDEX idx_user (user_id),
    INDEX idx_source (source_type, source_id)
) COMMENT '积分记录表';
```

## 4.9 定制域

### custom_demand 定制需求表

```sql
CREATE TABLE custom_demand (
    id BIGINT PRIMARY KEY,
    user_id BIGINT NOT NULL COMMENT '用户ID',
    phone VARCHAR(20) NOT NULL COMMENT '联系电话',

    -- 需求信息
    destination VARCHAR(100) NOT NULL COMMENT '目的地',
    travel_date_start DATE COMMENT '出行开始日期',
    travel_date_end DATE COMMENT '出行结束日期',
    travel_date_type VARCHAR(20) COMMENT '出行时间类型: this_weekend/next_week/this_month/custom',
    travel_days VARCHAR(20) COMMENT '出行天数: 3-5/6-8/9+/uncertain',
    adult_count INT DEFAULT 1 COMMENT '成人数',
    child_count INT DEFAULT 0 COMMENT '儿童数',
    budget VARCHAR(20) COMMENT '预算范围: <3k/3-5k/5-8k/8k-1w/>1w',
    requirements JSON COMMENT '其他需求标签 ["有老人","有小孩","蜜月"]',
    requirements_text VARCHAR(500) COMMENT '补充需求',

    -- 状态
    status TINYINT DEFAULT 0 COMMENT '状态: 0待处理 1跟进中 2已完成 3已关闭',

    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    INDEX idx_user (user_id),
    INDEX idx_status (status),
    INDEX idx_created (created_at)
) COMMENT '定制需求表';
```

### custom_followup 定制跟进记录表

```sql
CREATE TABLE custom_followup (
    id BIGINT PRIMARY KEY,
    demand_id BIGINT NOT NULL COMMENT '需求ID',

    content TEXT NOT NULL COMMENT '跟进内容',
    operator_id BIGINT NOT NULL COMMENT '操作人ID',
    operator_name VARCHAR(50) COMMENT '操作人姓名',

    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,

    INDEX idx_demand (demand_id)
) COMMENT '定制跟进记录表';
```

## 4.10 消息域

### message_record 消息记录表

```sql
CREATE TABLE message_record (
    id BIGINT PRIMARY KEY,
    user_id BIGINT NOT NULL COMMENT '接收用户ID',

    -- 消息信息
    type VARCHAR(32) NOT NULL COMMENT '消息类型: order_paid/order_confirmed/order_rejected/trip_reminder/refund_apply/refund_success/refund_reject/system',
    category VARCHAR(20) NOT NULL DEFAULT 'order' COMMENT '消息分类: order/system',
    title VARCHAR(100) NOT NULL COMMENT '消息标题',
    content TEXT COMMENT '消息内容',

    -- 关联业务
    biz_type VARCHAR(32) COMMENT '业务类型',
    biz_id BIGINT COMMENT '业务ID',
    biz_no VARCHAR(32) COMMENT '业务编号',

    -- 跳转
    jump_url VARCHAR(255) COMMENT '跳转路径',

    -- 状态
    is_read TINYINT DEFAULT 0 COMMENT '是否已读: 0未读 1已读',
    read_time DATETIME COMMENT '阅读时间',

    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,

    INDEX idx_user_read (user_id, is_read),
    INDEX idx_user_created (user_id, created_at DESC),
    INDEX idx_category (category)
) COMMENT '消息记录表';
```

## 4.11 内容域

### content_banner 轮播图表

```sql
CREATE TABLE content_banner (
    id BIGINT PRIMARY KEY,

    title VARCHAR(100) COMMENT '标题',
    image_url VARCHAR(500) NOT NULL COMMENT '图片URL',

    -- 跳转
    link_type TINYINT DEFAULT 0 COMMENT '跳转类型: 0无跳转 1线路详情 2外部链接 3小程序页面',
    link_value VARCHAR(500) COMMENT '跳转值(商品ID/URL/页面路径)',

    -- 状态
    status TINYINT DEFAULT 1 COMMENT '状态: 0禁用 1启用',
    sort_order INT DEFAULT 0 COMMENT '排序(越大越前)',

    start_time DATETIME COMMENT '开始展示时间',
    end_time DATETIME COMMENT '结束展示时间',

    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    INDEX idx_status_sort (status, sort_order DESC)
) COMMENT '轮播图表';
```

### content_category 分类表

```sql
CREATE TABLE content_category (
    id BIGINT PRIMARY KEY,

    name VARCHAR(50) NOT NULL COMMENT '分类名称',
    icon VARCHAR(500) COMMENT '图标URL',

    -- 关联
    biz_type VARCHAR(32) COMMENT '关联业务类型',

    -- 状态
    status TINYINT DEFAULT 1 COMMENT '状态: 0禁用 1启用',
    sort_order INT DEFAULT 0 COMMENT '排序',

    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    INDEX idx_status_sort (status, sort_order DESC)
) COMMENT '分类表';
```

## 4.12 系统域

### system_supplier 供应商表

```sql
CREATE TABLE system_supplier (
    id BIGINT PRIMARY KEY,

    -- 基本信息
    name VARCHAR(100) NOT NULL COMMENT '商家名称',
    logo VARCHAR(500) COMMENT 'Logo',
    phone VARCHAR(20) NOT NULL COMMENT '联系电话',
    intro TEXT COMMENT '简介',
    license_images JSON COMMENT '资质证书图片',

    -- 登录账号
    username VARCHAR(50) NOT NULL COMMENT '登录账号',
    password VARCHAR(100) NOT NULL COMMENT '登录密码(加密)',

    -- 状态
    status TINYINT DEFAULT 1 COMMENT '状态: 0禁用 1正常',

    last_login_at DATETIME COMMENT '最后登录时间',

    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    UNIQUE KEY uk_username (username)
) COMMENT '供应商表';
```

### system_admin 管理员表

```sql
CREATE TABLE system_admin (
    id BIGINT PRIMARY KEY,

    username VARCHAR(50) NOT NULL COMMENT '登录账号',
    password VARCHAR(100) NOT NULL COMMENT '登录密码(加密)',
    nickname VARCHAR(50) COMMENT '昵称',
    avatar VARCHAR(500) COMMENT '头像',
    phone VARCHAR(20) COMMENT '手机号',

    role VARCHAR(20) NOT NULL DEFAULT 'admin' COMMENT '角色: super_admin/admin',

    status TINYINT DEFAULT 1 COMMENT '状态: 0禁用 1正常',
    last_login_at DATETIME COMMENT '最后登录时间',

    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    UNIQUE KEY uk_username (username)
) COMMENT '管理员表';
```

### system_config 系统配置表

```sql
CREATE TABLE system_config (
    id BIGINT PRIMARY KEY,

    config_key VARCHAR(50) NOT NULL COMMENT '配置键',
    config_value TEXT NOT NULL COMMENT '配置值',
    config_type VARCHAR(20) DEFAULT 'string' COMMENT '类型: string/number/json/boolean',

    remark VARCHAR(200) COMMENT '备注',

    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    UNIQUE KEY uk_key (config_key)
) COMMENT '系统配置表';

-- 初始化配置数据
INSERT INTO system_config (id, config_key, config_value, config_type, remark) VALUES
(1, 'service_phone', '400-xxx-xxxx', 'string', '客服电话'),
(2, 'wework_customer_url', '', 'string', '企业微信客服链接'),
(3, 'pay_timeout_minutes', '30', 'number', '支付超时时间(分钟)'),
(4, 'member_price', '99', 'number', '会员年费(元)'),
(5, 'leader_price', '2000', 'number', '领队认证费(元)'),
(6, 'child_age_limit', '12', 'number', '儿童年龄上限'),
(7, 'refund_rules', '[{"days":7,"ratio":100},{"days":3,"ratio":70},{"days":1,"ratio":50},{"days":0,"ratio":0}]', 'json', '退款规则'),
(8, 'points_rule_order', '1', 'number', '下单积分比例(每消费1元得x积分)'),
(9, 'points_rule_promote', '10', 'number', '推广积分比例(每成交1单得x积分)');
```

## 4.13 优惠券域（P1）

### coupon_template 优惠券模板表

```sql
CREATE TABLE coupon_template (
    id BIGINT PRIMARY KEY,

    name VARCHAR(100) NOT NULL COMMENT '优惠券名称',
    type TINYINT NOT NULL COMMENT '类型: 1满减券 2折扣券',

    -- 面额/折扣
    amount DECIMAL(10,2) COMMENT '面额(满减券)',
    discount INT COMMENT '折扣(折扣券,如85表示8.5折)',

    -- 使用条件
    min_amount DECIMAL(10,2) DEFAULT 0 COMMENT '最低消费金额',
    max_discount DECIMAL(10,2) COMMENT '最大优惠金额(折扣券用)',

    -- 适用范围
    scope_type TINYINT DEFAULT 1 COMMENT '适用范围: 1全场 2指定业务类型 3指定商品',
    scope_value JSON COMMENT '范围值',

    -- 有效期
    valid_type TINYINT NOT NULL COMMENT '有效期类型: 1固定日期 2领取后N天',
    valid_start DATETIME COMMENT '有效期开始(固定日期)',
    valid_end DATETIME COMMENT '有效期结束(固定日期)',
    valid_days INT COMMENT '有效天数(领取后)',

    -- 发放设置
    total_count INT COMMENT '发放总量(-1不限)',
    issued_count INT DEFAULT 0 COMMENT '已发放数量',
    limit_per_user INT DEFAULT 1 COMMENT '每人限领',

    -- 状态
    status TINYINT DEFAULT 1 COMMENT '状态: 0禁用 1启用',

    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
) COMMENT '优惠券模板表';
```

### coupon_user 用户优惠券表

```sql
CREATE TABLE coupon_user (
    id BIGINT PRIMARY KEY,

    template_id BIGINT NOT NULL COMMENT '模板ID',
    user_id BIGINT NOT NULL COMMENT '用户ID',

    -- 冗余信息
    name VARCHAR(100) NOT NULL COMMENT '优惠券名称',
    type TINYINT NOT NULL COMMENT '类型',
    amount DECIMAL(10,2) COMMENT '面额',
    discount INT COMMENT '折扣',
    min_amount DECIMAL(10,2) COMMENT '最低消费',

    -- 有效期
    valid_start DATETIME NOT NULL COMMENT '有效期开始',
    valid_end DATETIME NOT NULL COMMENT '有效期结束',

    -- 状态
    status TINYINT DEFAULT 0 COMMENT '状态: 0未使用 1已使用 2已过期',

    -- 使用信息
    used_time DATETIME COMMENT '使用时间',
    used_order_id BIGINT COMMENT '使用订单ID',

    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    INDEX idx_user_status (user_id, status),
    INDEX idx_valid_end (valid_end)
) COMMENT '用户优惠券表';
```

---

# 第五部分：接口设计

## 5.1 接口规范

### 请求规范

| 项目 | 规范 |
|------|------|
| 协议 | HTTPS |
| 方法 | GET(查询)、POST(创建/操作)、PUT(更新)、DELETE(删除) |
| Content-Type | application/json |
| 编码 | UTF-8 |

### 响应格式

```json
{
    "code": 0,
    "message": "success",
    "data": {
        // 业务数据
    },
    "timestamp": 1706000000000
}
```

### 错误码规范

| 错误码 | 说明 |
|--------|------|
| 0 | 成功 |
| 400 | 参数错误 |
| 401 | 未登录 |
| 403 | 无权限 |
| 404 | 资源不存在 |
| 500 | 服务器错误 |
| 1001-1999 | 用户模块错误 |
| 2001-2999 | 商品模块错误 |
| 3001-3999 | 订单模块错误 |
| 4001-4999 | 支付模块错误 |

### 分页规范

请求参数：
```json
{
    "page": 1,
    "pageSize": 10
}
```

响应格式：
```json
{
    "code": 0,
    "data": {
        "list": [],
        "total": 100,
        "page": 1,
        "pageSize": 10,
        "totalPages": 10
    }
}
```

## 5.2 C端接口列表

### 用户模块

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 登录 | POST | /api/user/login | 微信登录 |
| 获取用户信息 | GET | /api/user/info | 当前用户信息 |
| 更新用户信息 | PUT | /api/user/info | 更新昵称头像等 |
| 绑定手机号 | POST | /api/user/bindPhone | 绑定手机号 |
| 出行人列表 | GET | /api/user/travelers | 出行人列表 |
| 添加出行人 | POST | /api/user/traveler | 添加出行人 |
| 更新出行人 | PUT | /api/user/traveler/{id} | 更新出行人 |
| 删除出行人 | DELETE | /api/user/traveler/{id} | 删除出行人 |

### 首页模块

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 首页数据 | GET | /api/home | 轮播图+功能入口+推荐 |
| 轮播图列表 | GET | /api/home/banners | 轮播图 |
| 热门线路 | GET | /api/home/hotRoutes | 热门推荐线路 |

### 线路模块

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 线路列表 | GET | /api/route/list | 线路分页列表 |
| 线路详情 | GET | /api/route/{id} | 线路详情 |
| 套餐列表 | GET | /api/route/{id}/packages | 套餐列表 |
| 套餐详情 | GET | /api/route/package/{id} | 套餐详情(含行程) |
| 日历价格 | GET | /api/route/package/{id}/calendar | 日历价格库存 |

### 订单模块

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 创建订单 | POST | /api/order/create | 创建订单 |
| 订单列表 | GET | /api/order/list | 订单分页列表 |
| 订单详情 | GET | /api/order/{id} | 订单详情 |
| 取消订单 | POST | /api/order/{id}/cancel | 取消订单 |
| 申请退款 | POST | /api/order/{id}/refund | 申请退款 |
| 待出行订单 | GET | /api/order/upcoming | 待出行订单列表 |

### 支付模块

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 获取支付参数 | POST | /api/pay/create | 获取微信支付参数 |
| 支付回调 | POST | /api/pay/notify | 微信支付回调 |
| 查询支付状态 | GET | /api/pay/status/{orderNo} | 查询支付状态 |

### 定制模块

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 提交定制需求 | POST | /api/custom/submit | 提交定制需求 |
| 我的定制 | GET | /api/custom/list | 我的定制需求列表 |

### 会员模块

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 会员信息 | GET | /api/member/info | 会员权益和状态 |
| 开通会员 | POST | /api/member/open | 开通会员 |

### 领队模块

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 领队信息 | GET | /api/leader/info | 领队信息和状态 |
| 申请领队 | POST | /api/leader/apply | 提交领队申请 |
| 申请状态 | GET | /api/leader/applyStatus | 申请状态查询 |

### 推广模块

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 推广信息 | GET | /api/promoter/info | 推广员信息 |
| 申请推广员 | POST | /api/promoter/apply | 申请成为推广员 |
| 更新店铺信息 | PUT | /api/promoter/shop | 更新店铺信息 |
| 获取推广码 | GET | /api/promoter/qrcode | 获取小程序码 |
| 推广绑定 | POST | /api/promoter/bindByCode | 扫码绑定推广员 |

### 积分模块

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 积分余额 | GET | /api/points/balance | 积分余额 |
| 积分明细 | GET | /api/points/records | 积分记录列表 |

### 优惠券模块

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 我的优惠券 | GET | /api/coupon/list | 优惠券列表 |
| 可用优惠券 | GET | /api/coupon/available | 下单可用优惠券 |

### 消息模块

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 未读数量 | GET | /api/message/unreadCount | 未读消息数 |
| 消息列表 | GET | /api/message/list | 消息列表 |
| 标记已读 | POST | /api/message/{id}/read | 标记已读 |
| 全部已读 | POST | /api/message/readAll | 全部标记已读 |

## 5.3 B端接口列表

### 认证模块

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 登录 | POST | /admin/auth/login | 管理员/供应商登录 |
| 登出 | POST | /admin/auth/logout | 登出 |
| 获取用户信息 | GET | /admin/auth/info | 当前登录信息 |

### 线路管理（供应商）

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 线路列表 | GET | /admin/route/list | 线路分页列表 |
| 线路详情 | GET | /admin/route/{id} | 线路详情 |
| 创建线路 | POST | /admin/route | 创建线路 |
| 更新线路 | PUT | /admin/route/{id} | 更新线路 |
| 删除线路 | DELETE | /admin/route/{id} | 删除线路 |
| 上架线路 | POST | /admin/route/{id}/online | 上架 |
| 下架线路 | POST | /admin/route/{id}/offline | 下架 |
| 套餐列表 | GET | /admin/route/{id}/packages | 套餐列表 |
| 创建套餐 | POST | /admin/route/{id}/package | 创建套餐 |
| 更新套餐 | PUT | /admin/route/package/{id} | 更新套餐 |
| 删除套餐 | DELETE | /admin/route/package/{id} | 删除套餐 |
| 价格库存 | GET | /admin/route/package/{id}/prices | 价格库存列表 |
| 设置价格库存 | POST | /admin/route/package/{id}/prices | 批量设置价格库存 |

### 订单管理

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 订单列表 | GET | /admin/order/list | 订单分页列表 |
| 订单详情 | GET | /admin/order/{id} | 订单详情 |
| 确认订单 | POST | /admin/order/{id}/confirm | 确认接单 |
| 拒绝订单 | POST | /admin/order/{id}/reject | 拒绝接单 |
| 导出订单 | GET | /admin/order/export | 导出Excel |

### 退款管理

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 退款列表 | GET | /admin/refund/list | 退款分页列表 |
| 退款详情 | GET | /admin/refund/{id} | 退款详情 |
| 审核通过 | POST | /admin/refund/{id}/approve | 审核通过 |
| 审核驳回 | POST | /admin/refund/{id}/reject | 审核驳回 |

### 定制管理

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 定制列表 | GET | /admin/custom/list | 定制需求列表 |
| 定制详情 | GET | /admin/custom/{id} | 定制详情 |
| 更新状态 | POST | /admin/custom/{id}/status | 更新状态 |
| 添加跟进 | POST | /admin/custom/{id}/followup | 添加跟进记录 |

### 会员管理（管理员）

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 会员列表 | GET | /admin/member/list | 会员列表 |
| 会员详情 | GET | /admin/member/{id} | 会员详情 |

### 领队管理（管理员）

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 领队列表 | GET | /admin/leader/list | 领队列表 |
| 申请列表 | GET | /admin/leader/applies | 申请列表 |
| 审核申请 | POST | /admin/leader/apply/{id}/audit | 审核 |

### 推广管理（管理员）

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 推广员列表 | GET | /admin/promoter/list | 推广员列表 |
| 审核推广员 | POST | /admin/promoter/{id}/audit | 审核 |
| 绑定记录 | GET | /admin/promoter/bindlogs | 绑定记录 |

### 供应商管理（管理员）

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 供应商列表 | GET | /admin/supplier/list | 供应商列表 |
| 创建供应商 | POST | /admin/supplier | 创建供应商 |
| 更新供应商 | PUT | /admin/supplier/{id} | 更新供应商 |
| 启用/禁用 | POST | /admin/supplier/{id}/status | 启用禁用 |

### 内容管理（管理员）

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 轮播图列表 | GET | /admin/banner/list | 轮播图列表 |
| 创建轮播图 | POST | /admin/banner | 创建 |
| 更新轮播图 | PUT | /admin/banner/{id} | 更新 |
| 删除轮播图 | DELETE | /admin/banner/{id} | 删除 |

### 系统配置（管理员）

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 获取配置 | GET | /admin/config/list | 配置列表 |
| 更新配置 | PUT | /admin/config | 更新配置 |

### 文件上传

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 上传图片 | POST | /admin/upload/image | 上传图片到COS |

---

# 第六部分：部署方案

## 6.1 服务器配置建议

### 初期配置（单机）

| 资源 | 配置 | 说明 |
|------|------|------|
| 云服务器 | 4核8G | 腾讯云/阿里云 |
| 系统盘 | 50G SSD | 系统+应用 |
| 数据盘 | 100G SSD | MySQL数据 |
| 带宽 | 5Mbps | 可按需升级 |
| MySQL | 云数据库 2核4G | 或自建 |
| Redis | 云Redis 1G | 或自建 |
| COS | 标准存储 | 按量付费 |

### 生产环境配置

| 资源 | 配置 | 说明 |
|------|------|------|
| 应用服务器 | 2台 4核8G | 负载均衡 |
| MySQL | 云数据库 4核8G | 主从 |
| Redis | 云Redis 4G | 主从 |
| 负载均衡 | CLB | 腾讯云/阿里云 |

## 6.2 部署架构

```
                    ┌─────────────┐
                    │   CDN       │
                    │ (静态资源)   │
                    └──────┬──────┘
                           │
                    ┌──────▼──────┐
                    │   负载均衡   │
                    │   (CLB)     │
                    └──────┬──────┘
                           │
              ┌────────────┴────────────┐
              ▼                         ▼
       ┌─────────────┐          ┌─────────────┐
       │   Nginx-1   │          │   Nginx-2   │
       │  (App-1)    │          │  (App-2)    │
       └──────┬──────┘          └──────┬──────┘
              │                         │
              └────────────┬────────────┘
                           │
         ┌─────────────────┼─────────────────┐
         ▼                 ▼                 ▼
  ┌─────────────┐   ┌─────────────┐   ┌─────────────┐
  │    MySQL    │   │    Redis    │   │     COS     │
  │   (主从)    │   │   (主从)    │   │   (存储)    │
  └─────────────┘   └─────────────┘   └─────────────┘
```

## 6.3 Docker部署

### docker-compose.yml

```yaml
version: '3.8'

services:
  # Nginx
  nginx:
    image: nginx:1.24
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/conf.d:/etc/nginx/conf.d
      - ./nginx/ssl:/etc/nginx/ssl
      - ./admin-web/dist:/usr/share/nginx/html/admin
    depends_on:
      - xj-app
      - xj-admin
    restart: always

  # 小程序后端
  xj-app:
    image: openjdk:17-slim
    volumes:
      - ./xj-app/target/xj-app.jar:/app/app.jar
      - ./logs/xj-app:/app/logs
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - JAVA_OPTS=-Xms512m -Xmx1024m
    command: java ${JAVA_OPTS} -jar /app/app.jar
    restart: always

  # 管理后台后端
  xj-admin:
    image: openjdk:17-slim
    volumes:
      - ./xj-admin/target/xj-admin.jar:/app/app.jar
      - ./logs/xj-admin:/app/logs
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - JAVA_OPTS=-Xms512m -Xmx1024m
    command: java ${JAVA_OPTS} -jar /app/app.jar
    restart: always

  # MySQL (开发环境用，生产建议用云数据库)
  mysql:
    image: mysql:8.0
    ports:
      - "3306:3306"
    volumes:
      - ./mysql/data:/var/lib/mysql
      - ./mysql/conf:/etc/mysql/conf.d
      - ./mysql/init:/docker-entrypoint-initdb.d
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - MYSQL_DATABASE=xunjiqianxing
    restart: always

  # Redis (开发环境用，生产建议用云Redis)
  redis:
    image: redis:7
    ports:
      - "6379:6379"
    volumes:
      - ./redis/data:/data
    command: redis-server --appendonly yes
    restart: always
```

### Nginx配置

```nginx
# /etc/nginx/conf.d/xunjiqianxing.conf

# 小程序API
upstream xj-app {
    server xj-app:8080;
}

# 管理后台API
upstream xj-admin {
    server xj-admin:8081;
}

server {
    listen 443 ssl;
    server_name api.xunjiqianxing.com;

    ssl_certificate     /etc/nginx/ssl/api.crt;
    ssl_certificate_key /etc/nginx/ssl/api.key;

    # 小程序API
    location /api/ {
        proxy_pass http://xj-app/api/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # 支付回调
    location /pay/ {
        proxy_pass http://xj-app/pay/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}

server {
    listen 443 ssl;
    server_name admin.xunjiqianxing.com;

    ssl_certificate     /etc/nginx/ssl/admin.crt;
    ssl_certificate_key /etc/nginx/ssl/admin.key;

    # 管理后台前端
    location / {
        root /usr/share/nginx/html/admin;
        index index.html;
        try_files $uri $uri/ /index.html;
    }

    # 管理后台API
    location /admin/ {
        proxy_pass http://xj-admin/admin/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
```

---

# 第七部分：开发规范

## 7.1 代码规范

### Java代码规范

| 规范 | 说明 |
|------|------|
| 命名 | 遵循阿里巴巴Java开发手册 |
| 注释 | 类、方法必须有JavaDoc |
| 日志 | 使用Slf4j，关键操作打印日志 |
| 异常 | 业务异常统一使用BizException |
| 参数校验 | 使用Validation注解 |
| 返回值 | 统一使用Result包装 |

### 前端代码规范

| 规范 | 说明 |
|------|------|
| 命名 | 组件PascalCase，变量camelCase |
| 格式化 | 使用Prettier |
| Lint | 使用ESLint |
| 样式 | 使用SCSS，BEM命名 |

## 7.2 Git规范

### 分支规范

| 分支 | 说明 |
|------|------|
| main | 主分支，生产代码 |
| develop | 开发分支 |
| feature/xxx | 功能分支 |
| hotfix/xxx | 紧急修复分支 |
| release/xxx | 发布分支 |

### 提交规范

```
<type>(<scope>): <subject>

type:
- feat: 新功能
- fix: 修复Bug
- docs: 文档
- style: 格式
- refactor: 重构
- test: 测试
- chore: 构建/工具

示例:
feat(order): 添加订单取消功能
fix(pay): 修复支付回调重复问题
```

## 7.3 安全规范

| 安全项 | 措施 |
|--------|------|
| SQL注入 | 使用MyBatis参数绑定，禁止拼接SQL |
| XSS | 前端过滤，后端转义 |
| CSRF | 使用Token验证 |
| 敏感数据 | 身份证、密码加密存储 |
| 日志脱敏 | 手机号、身份证脱敏打印 |
| 接口限流 | 使用Redis实现限流 |
| 权限控制 | Sa-Token权限校验 |

## 7.4 测试规范

| 测试类型 | 覆盖范围 |
|----------|----------|
| 单元测试 | Service层核心方法 |
| 集成测试 | API接口 |
| 功能测试 | 核心业务流程 |

---

# 第八部分：开发计划

## 8.1 里程碑规划

| 阶段 | 内容 | 产出 |
|------|------|------|
| M1 | 基础框架搭建 | 项目骨架、数据库、公共模块 |
| M2 | 核心业务开发 | 用户、商品、订单、支付 |
| M3 | 扩展功能开发 | 会员、领队、推广、定制、消息 |
| M4 | 管理后台开发 | B端功能完善 |
| M5 | 联调测试 | 前后端联调、测试 |
| M6 | 上线 | 部署、发布 |

## 8.2 技术风险

| 风险 | 应对措施 |
|------|----------|
| 微信支付对接 | 提前申请商户号，预留联调时间 |
| 小程序审核 | 预留审核时间，准备应急方案 |
| 数据安全 | 敏感数据加密，定期备份 |
| 并发问题 | 库存使用Redis+数据库双重校验 |

---

# 附录

## A. 状态枚举定义

### 订单状态

| 状态码 | 名称 | 说明 |
|--------|------|------|
| pending_pay | 待支付 | 订单创建，等待支付 |
| pending_confirm | 待确认 | 已支付，等待商家确认 |
| confirmed | 已确认 | 商家已确认 |
| completed | 已完成 | 行程结束 |
| cancelled | 已取消 | 用户取消或超时 |
| refunding | 退款中 | 申请退款，待审核 |
| refunded | 已退款 | 退款完成 |
| rejected | 已拒绝 | 商家拒绝，已退款 |

### 业务类型

| 类型码 | 名称 | 说明 |
|--------|------|------|
| route | 跟团游 | 一期 |
| car | 租车自驾 | 二期 |
| hotel | 民宿酒店 | 二期 |
| ticket | 景点门票 | 二期 |
| transfer | 接送包车 | 二期 |
| food | 美食玩乐 | 二期 |
| rental | 租赁服务 | 二期 |
| insurance | 旅游保险 | 二期 |

## B. 第三方服务配置

### 微信小程序配置

```yaml
wechat:
  miniapp:
    appid: ${WECHAT_APPID}
    secret: ${WECHAT_SECRET}
```

### 微信支付配置

```yaml
wechat:
  pay:
    appid: ${WECHAT_APPID}
    mchid: ${WECHAT_MCHID}
    apiV3Key: ${WECHAT_API_V3_KEY}
    certPath: ${WECHAT_CERT_PATH}
    keyPath: ${WECHAT_KEY_PATH}
    notifyUrl: https://api.xunjiqianxing.com/pay/notify
```

### 腾讯云COS配置

```yaml
tencent:
  cos:
    secretId: ${COS_SECRET_ID}
    secretKey: ${COS_SECRET_KEY}
    region: ap-guangzhou
    bucket: xunjiqianxing-xxx
```

---

*— 文档结束 —*

**版本历史**

| 版本 | 日期 | 说明 |
|------|------|------|
| V1.0 | 2026-01 | 初稿 |
